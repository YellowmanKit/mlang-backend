{"version":3,"sources":["../../../src/main/routers/user.js"],"names":["ObjectId","require","Types","UserRouter","app","init","mongoose","connect","db","connection","post","req","res","next","data","body","err","existedUser","User","findOne","id","pw","console","log","json","result","_id","toString","findOneAndUpdate","$set","type","email","new","updatedUser","get","headers","resetPassword","acquireNewAccount","user","profile","othersProfile","course","subject","project","studentProject","school","profiles","Profile","belongTo","push","courses","subjects","joinedCourses","joinedSubjects","today","Date","i","length","Course","findById","teacher","endDate","Subject","teachingCourses","teachingSubjects","teachingCoursesData","find","studentProjects","StudentProject","student","schools","supervisingSchools","School","admin","map","joinedSchools","Router"],"mappings":"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","file":"user.js","sourcesContent":["import Router from './Router';\r\nimport path from 'path';\r\nimport mongoose from 'mongoose';\r\nvar ObjectId = require('mongoose').Types.ObjectId;\r\n\r\nimport to from '../../to';\r\n\r\nimport User from '../../models/User.js';\r\nimport Profile from '../../models/Profile.js';\r\nimport School from '../../models/School.js';\r\nimport Course from '../../models/Course.js';\r\nimport Subject from '../../models/Subject.js';\r\nimport Project from '../../models/Project.js';\r\nimport StudentProject from '../../models/StudentProject.js';\r\n\r\nclass UserRouter extends Router {\r\n\r\n  constructor(app){\r\n    super(app);\r\n    this.app = app;\r\n    this.init();\r\n  }\r\n\r\n  init(){\r\n    const app = this.app;\r\n    mongoose.connect('mongodb://localhost/mlang');\r\n    var db = mongoose.connection;\r\n\r\n    app.post('/user/update', async(req, res, next)=>{\r\n      const data = req.body.data;\r\n      //console.log(data)\r\n      let err, existedUser;\r\n      [err, existedUser] = await to(User.findOne({id: data.id, pw: data.pw}));\r\n      if(err){ console.log(err); return res.json({ result: 'failed'})}\r\n      if(existedUser && existedUser._id.toString() !== data._id){ console.log('user id/pw already used'); return res.json({ result: 'failed'}) }\r\n\r\n      User.findOneAndUpdate({_id: data._id}, { $set:{\r\n        type: data.type,\r\n        id: data.id,\r\n        pw: data.pw,\r\n        email: data.email\r\n      }}, {new: true}, (err, updatedUser)=>{\r\n        //console.log(_updatedUser)\r\n        return res.json({\r\n          result: (err || !updatedUser)? 'failed':'success' ,\r\n          updatedUser: updatedUser\r\n        });\r\n      });\r\n    });\r\n\r\n    app.get('/user/resetPassword/', async (req, res, next)=>{\r\n      const email = req.headers.email;\r\n\r\n      User.resetPassword(email, result=>{\r\n        return res.json({ result: result });\r\n      });\r\n    });\r\n\r\n    app.get('/user/getNewAccount/', (req, res, next)=>{\r\n      const email = req.headers.email;\r\n\r\n      User.acquireNewAccount(email, result=>{\r\n        return res.json({ result: result });\r\n      });\r\n    });\r\n\r\n    app.get('/user/login/', async (req, res, next)=>{\r\n      const id = req.headers.id;\r\n      const pw = req.headers.pw;\r\n      let err, user, profile, othersProfile, course, subject, project, studentProject, school;\r\n      var profiles = [];\r\n\r\n      [err, user] = await to(User.findOne({id, pw}));\r\n      if(err || !user){ console.log(err); console.log(user); return res.json({ result: \"failed\" });}\r\n\r\n      [err, profile] = await to(Profile.findOne({belongTo: user._id}));\r\n      if(err || profile === null){ return res.json({ result: \"failed\" });}\r\n      profiles.push(profile);\r\n\r\n      var courses = [];\r\n      var subjects = [];\r\n\r\n      var joinedCourses = profile.joinedCourses;\r\n      var joinedSubjects = [];\r\n\r\n      const today = new Date();\r\n\r\n      for(var i=0;i<joinedCourses.length;i++){\r\n        [err, course] = await to(Course.findById(joinedCourses[i]));\r\n        if(err || course === null){ return res.json({ result: \"failed\" });}\r\n\r\n        courses.push(course);\r\n\r\n        [err, othersProfile] = await to(Profile.findOne({belongTo: course.teacher}));\r\n        if(err || othersProfile === null){ return res.json({ result: \"failed\" });}\r\n        profiles.push(othersProfile);\r\n\r\n        const endDate = new Date(course.endDate);\r\n        if(endDate < today){ continue; }\r\n        joinedSubjects = [...joinedSubjects, ...course.subjects];\r\n      }\r\n\r\n      for(var i=0;i<joinedSubjects.length;i++){\r\n        [err, subject] = await to(Subject.findById(joinedSubjects[i]._id));\r\n        if(err || subject === null){ return res.json({ result: \"failed\" });}\r\n        subjects.push(subject)\r\n      }\r\n\r\n      var teachingCourses = [];\r\n      var teachingSubjects = [];\r\n\r\n      var teachingCoursesData = [];\r\n      [err, teachingCoursesData] = await to(Course.find({teacher: user._id}));\r\n      if(err){ return res.json({ result: \"failed\" });}\r\n      courses = [...courses, ...teachingCoursesData];\r\n\r\n      for(var i=0;i<teachingCoursesData.length;i++){\r\n        teachingCourses.push(teachingCoursesData[i]._id);\r\n        const endDate = new Date(teachingCoursesData[i].endDate);\r\n        if(endDate < today){ continue; }\r\n        teachingSubjects = [...teachingSubjects, ...teachingCoursesData[i].subjects];\r\n      }\r\n\r\n      for(var i=0;i<teachingSubjects.length;i++){\r\n        [err, subject] = await to(Subject.findById(teachingSubjects[i]._id));\r\n        if(err || subject === null){ return res.json({ result: \"failed\" });}\r\n        subjects.push(subject)\r\n      }\r\n\r\n      var studentProjects = [];\r\n      [err, studentProjects] = await to(StudentProject.find({student: user._id}));\r\n\r\n      var schools = [];\r\n      var supervisingSchools = [];\r\n      [err, schools] = await(to(School.find({admin: user._id})));\r\n      if(err || schools === null){ return res.json({ result: \"failed\" });}\r\n      schools.map(school=>{\r\n        supervisingSchools.push(school._id);\r\n        return null;\r\n      });\r\n\r\n      const joinedSchools = profile.joinedSchools;\r\n      for(var i=0;i<joinedSchools.length;i++){\r\n        [err, school] = await to(School.findById(joinedSchools[i]));\r\n        if(err || school === null){ return res.json({ result: \"failed\" });}\r\n        schools.push(school);\r\n      }\r\n\r\n      return res.json({\r\n        result: \"success\",\r\n        user: user,\r\n        profile: profile,\r\n        profiles: profiles,\r\n\r\n        supervisingSchools: supervisingSchools,\r\n\r\n        teachingCourses: teachingCourses,\r\n        joinedCourses: joinedCourses,\r\n\r\n        teachingSubjects: teachingSubjects,\r\n        joinedSubjects: joinedSubjects,\r\n\r\n        schools: schools,\r\n        courses: courses,\r\n        subjects: subjects,\r\n        studentProjects: studentProjects\r\n      })\r\n    });\r\n\r\n  }\r\n\r\n}\r\n\r\nexport default UserRouter;\r\n"]}